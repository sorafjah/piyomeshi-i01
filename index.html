<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#87CEEB" />
    <title>ã´ã‚ˆãƒ©ãƒ³ãƒğŸ¥</title>

    <link rel="manifest" href="manifest.json" />

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #87ceeb;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            height: 100vh;
            width: 100vw;
            -webkit-tap-highlight-color: transparent;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        #startScreen,
        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }
        h1 {
            font-size: 42px;
            margin-bottom: 10px;
            color: #00bfff;
            text-align: center;
            font-weight: 900;
        }
        p {
            font-size: 14px;
            color: #555;
            text-align: center;
            line-height: 1.6;
            margin: 5px 0;
        }
        .instructions {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 85%;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 70%;
            max-width: 260px;
            margin-top: 10px;
        }
        button {
            padding: 14px 20px;
            font-size: 18px;
            background-color: #ffcc00;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 0 #d4a000;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
            width: 100%;
        }
        button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 0 #d4a000;
        }
        button.secondary {
            background-color: #fff9c4;
            box-shadow: 0 4px 0 #fbc02d;
            color: #555;
        }
        button.secondary:active {
            box-shadow: 0 2px 0 #fbc02d;
        }
        .hidden {
            display: none !important;
        }
        #feverIndicator {
            position: absolute;
            top: calc(100px + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            font-weight: bold;
            color: #ff0055;
            text-shadow: 2px 2px 0 #fff;
            display: none;
            pointer-events: none;
            animation: pulse 0.3s infinite alternate;
            width: 100%;
            text-align: center;
        }
        @keyframes pulse {
            from { transform: translateX(-50%) scale(1); }
            to { transform: translateX(-50%) scale(1.2); }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="feverIndicator">ğŸ”¥ FEVER TIME! ğŸ”¥</div>

    <div id="startScreen">
        <h1>ã´ã‚ˆãƒ©ãƒ³ãƒğŸ¤</h1>
        <p>ãƒ’ãƒ¨ã‚³ã«ã”ã¯ã‚“ã‚’ã‚ã’ã‚ˆã†</p>
        <div class="instructions">
            <p>
                <b>æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—</b> ã§ç§»å‹•<br />
                <b>ã‚¿ãƒƒãƒ</b> ã§ã‚¸ãƒ£ãƒ³ãƒ—<br />
                <br />
                <span style="color: #ff0055; font-weight: bold">ãƒ«ãƒ¼ãƒ«:</span><br />
                ğŸ™<b>ãŠã«ãã‚Š</b>ã§ä½“åŠ›å›å¾©ï¼<br />
                ğŸŒµğŸ•ğŸã«æ°—ã‚’ä»˜ã‘ã¦ï¼<br />
            </p>
        </div>
        <div class="btn-group">
            <button onclick="startGame(true)">ğŸ”Š éŸ³ã‚ã‚Šã§ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button onclick="startGame(false)" class="secondary">ğŸ”‡ éŸ³ãªã—ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
    </div>

    <div id="gameOverScreen" class="hidden">
        <h1>ãŠãªã‹ã„ã£ã±ã„...</h1>
        <p style="font-size: 20px; font-weight: bold">ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></p>
        <p>è‚²ã¦ãŸãƒ‹ãƒ¯ãƒˆãƒª: <span id="chickenCount">0</span> ç¾½</p>
        <br />
        <div class="btn-group">
            <button onclick="resetGame()">ã‚‚ã†ä¸€å›ï¼</button>
        </div>
    </div>

    <script>
        // Service Workerã®ç™»éŒ²
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", function () {
                navigator.serviceWorker.register("./sw.js").catch(function (err) {});
            });
        }

        const canvas = document.getElementById("gameCanvas");
        // alpha: false ã¯èƒŒæ™¯ã‚’ä¸é€æ˜ã«ã—ã¦é«˜é€ŸåŒ–ã™ã‚‹é‡è¦ãªè¨­å®š
        const ctx = canvas.getContext("2d", { alpha: false });
        const feverText = document.getElementById("feverIndicator");

        let gameState = "start";
        let score = 0;
        let chickensGrown = 0;
        let maxHealth = 100;
        let health = 100;
        let frameCount = 0;
        let feverTimer = 0;
        const FEVER_DURATION = 1200;

        let dpr = 1;
        let width, height;

        // è»½é‡åŒ–è¨­å®š
        const MAX_ITEMS = 10;
        const MAX_ENEMIES = 5;
        const MAX_CACTUS = 3;
        const MAX_PARTICLES = 50; // å°‘ã—æ¸›ã‚‰ã—ã¦è»½é‡åŒ–
        const MAX_FLOAT_TEXTS = 10;

        // 60fpsåŒ–ã«ä¼´ã„é‡åŠ›ç­‰ã®ä¿‚æ•°ã‚’èª¿æ•´ (å…ƒã®åŠåˆ†ãã‚‰ã„ã«è¨­å®š)
        const GRAVITY = 0.35;
        const GROUND_OFFSET = 100;
        const GROUND_Y = () => height - GROUND_OFFSET;
        const CHICK_ZONE_HIGH_OFFSET = 270;
        const CHICK_ZONE_HIGHEST_OFFSET = 380;

        const NORMAL_FOODS = ["ğŸ‡", "ğŸ”", "ğŸ¥¦", "ğŸ°"];
        const FOOD_SIZE_BASE = 29;
        const CLOUDS = [
            { x: 50, y: 80, w: 80, h: 40, speed: 0.15 },
            { x: 300, y: 150, w: 100, h: 50, speed: 0.1 },
            { x: 600, y: 100, w: 70, h: 35, speed: 0.2 },
            { x: 800, y: 200, w: 120, h: 60, speed: 0.12 }
        ];

        const player = {
            x: 0, y: 0, vx: 0, vy: 0, width: 20, height: 40,
            grounded: false, stunned: false, stunTimer: 0, color: "#333"
        };

        let chicks = [], items = [], enemies = [], particles = [], floatingTexts = [], cactusList = [];
        const emojiCache = {};

        // é«˜é€ŸåŒ–: çµµæ–‡å­—ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        function getEmojiImage(emoji, size) {
            const key = emoji + "_" + size;
            if (emojiCache[key]) return emojiCache[key];
            
            const c = document.createElement("canvas");
            const s = Math.ceil(size * 1.2);
            c.width = s;
            c.height = s;
            const cx = c.getContext("2d");
            // iOSæ¨™æº–ãƒ•ã‚©ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ç„¡é§„ãªãƒ•ã‚©ãƒ³ãƒˆæ¤œç´¢ã‚’é˜²ã
            cx.font = size + "px -apple-system, sans-serif";
            cx.textAlign = "center";
            cx.textBaseline = "middle";
            cx.fillText(emoji, s / 2, s / 2 + size * 0.05);
            emojiCache[key] = c;
            return c;
        }

        function resize() {
            dpr = 1; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å„ªå…ˆ
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + "px";
            canvas.style.height = height + "px";
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            
            // å†ã‚µã‚¤ã‚ºæ™‚ã«åˆæœŸä½ç½®ãŒãŠã‹ã—ããªã‚‰ãªã„ã‚ˆã†ã‚¬ãƒ¼ãƒ‰
            if (gameState === "playing" && player.y > GROUND_Y()) {
                player.y = GROUND_Y();
            }
        }

        let resizeTimeout;
        window.addEventListener("resize", () => {
            if (resizeTimeout) clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(resize, 200);
        });

        // --- ã‚µã‚¦ãƒ³ãƒ‰é–¢é€£ (è»½é‡åŒ–: AudioContextã®å†åˆ©ç”¨) ---
        let audioCtx = null;
        let isMuted = true;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === "suspended") {
                audioCtx.resume();
            }
        }

        function playSound(type) {
            if (isMuted || !audioCtx) return;
            
            // åŒæ™‚ç™ºéŸ³æ•°ãŒå¤šã™ãã‚‹ã¨é‡ããªã‚‹ãŸã‚ã€ç°¡æ˜“çš„ãªé–“å¼•ãã‚’ã—ã¦ã‚‚è‰¯ã„ãŒ
            // Oscillatorãƒãƒ¼ãƒ‰ãªã‚‰ãã“ã¾ã§é‡ããªã„ã®ã§ãã®ã¾ã¾å®Ÿè£…
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === "hit") {
                osc.type = "triangle";
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(900, now + 0.05);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === "damage") {
                osc.type = "sawtooth";
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === "bounce") {
                osc.type = "square";
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(300, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === "heal") {
                osc.type = "sine";
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.setValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === "feed") {
                osc.type = "sine";
                osc.frequency.setValueAtTime(900, now);
                osc.frequency.exponentialRampToValueAtTime(1400, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            }
        }

        // --- ä¸è¶³ã—ã¦ã„ãŸé–¢æ•°ã‚’è¿½åŠ  (ã“ã‚ŒãŒãªã„ã¨ã‚¨ãƒ©ãƒ¼ã§æ¿€é‡ã«ãªã‚Šã¾ã™) ---
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                if (particles.length >= MAX_PARTICLES) break;
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6,
                    life: Math.random() * 20 + 10,
                    color: color,
                    size: Math.random() * 4 + 2
                });
            }
        }

        function showFloatText(x, y, text, color) {
            floatingTexts.push({
                x: x,
                y: y,
                text: text,
                color: color,
                life: 40
            });
        }
        // -------------------------------------------------------------

        function init() {
            resize();
            player.x = width / 2;
            player.y = GROUND_Y();
            player.vx = 0;
            player.vy = 0;
            player.stunned = false;

            items = [];
            particles = [];
            enemies = [];
            cactusList = [];
            floatingTexts = [];
            chicks = [];

            const chickCount = 2;
            for (let i = 0; i < chickCount; i++) spawnChick(i);

            score = 0;
            chickensGrown = 0;
            health = 100;
            frameCount = 0;
            feverTimer = 0;
        }

        function spawnChick(index) {
            let offset;
            let rowType;
            if (index === 0) {
                offset = CHICK_ZONE_HIGH_OFFSET;
                rowType = "high";
            } else {
                offset = CHICK_ZONE_HIGHEST_OFFSET;
                rowType = "highest";
            }
            const baseY = GROUND_Y() - offset;
            const yPos = baseY - Math.random() * 20;
            chicks.push({
                x: Math.random() * (width - 60) + 30,
                y: yPos,
                targetX: Math.random() * (width - 60) + 30,
                row: rowType,
                baseY: yPos,
                stage: 0,
                emoji: "ğŸ£",
                scale: 1.0,
                state: "idle",
                waitTimer: 0
            });
        }

        function startGame(enableSound) {
            isMuted = !enableSound;
            if (!isMuted) initAudio();
            document.getElementById("startScreen").classList.add("hidden");
            document.getElementById("gameOverScreen").classList.add("hidden");
            init();
            gameState = "playing";
            loop();
        }

        function resetGame() {
            document.getElementById("gameOverScreen").classList.add("hidden");
            document.getElementById("startScreen").classList.remove("hidden");
        }

        function gameOver() {
            gameState = "gameover";
            document.getElementById("finalScore").innerText = score;
            document.getElementById("chickenCount").innerText = chickensGrown;
            document.getElementById("gameOverScreen").classList.remove("hidden");
            feverText.style.display = "none";
        }

        // --- å…¥åŠ›å‡¦ç† ---
        let touchStartX = 0;
        canvas.addEventListener("touchstart", (e) => {
            if (gameState !== "playing") return;
            const touch = e.touches[0];
            touchStartX = touch.clientX;
        }, { passive: false });

        canvas.addEventListener("touchmove", (e) => {
            if (gameState !== "playing" || player.stunned) return;
            // ç”»é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            e.preventDefault(); 
            const touch = e.touches[0];
            const diffX = touch.clientX - touchStartX;
            // 60fpsç”¨ã«ä¿‚æ•°èª¿æ•´
            if (player.grounded) {
                player.vx += diffX * 0.09; // å…ƒã®åŠåˆ†ç¨‹åº¦
            } else {
                player.vx += diffX * 0.04;
            }
            // é€Ÿåº¦åˆ¶é™
            if (player.vx > 10) player.vx = 10;
            if (player.vx < -10) player.vx = -10;
            touchStartX = touch.clientX;
        }, { passive: false });

        canvas.addEventListener("touchend", (e) => {
            if (gameState !== "playing" || player.stunned) return;
            if (player.grounded) {
                const touch = e.changedTouches[0];
                const diffX = touch.clientX - touchStartX;
                
                player.vy = -10; // ã‚¸ãƒ£ãƒ³ãƒ—åŠ›å°‘ã—èª¿æ•´
                player.grounded = false;
                
                let jumpBoost = diffX * 0.3;
                if (jumpBoost > 6) jumpBoost = 6;
                if (jumpBoost < -6) jumpBoost = -6;
                player.vx += jumpBoost;
                
                createParticles(player.x, player.y + 20, 3, "#ccc");
            }
        });

        // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— (ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—å»ƒæ­¢ã§æ»‘ã‚‰ã‹ã«) ---
        function loop() {
            if (gameState !== "playing") return;
            
            // èƒŒæ™¯å¡—ã‚Šã¤ã¶ã—ï¼ˆclearRectã‚ˆã‚Šé«˜é€Ÿã§å®‰å…¨ï¼‰
            ctx.fillStyle = "#87CEEB";
            ctx.fillRect(0, 0, width, height);
            
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            frameCount++;

            if (feverTimer > 0) {
                feverTimer--;
                feverText.style.display = "block";
            } else {
                feverText.style.display = "none";
            }

            if (player.stunned) {
                player.stunTimer--;
                if (player.stunTimer <= 0) player.stunned = false;
            }

            player.vy += GRAVITY;
            player.x += player.vx;
            player.y += player.vy;

            // æ‘©æ“¦ä¿‚æ•°èª¿æ•´ (60fpsç”¨)
            if (player.grounded) {
                player.vx *= 0.90; 
            } else {
                player.vx *= 0.97;
            }
            if (Math.abs(player.vx) < 0.1) player.vx = 0;

            if (player.x < 10) {
                player.x = 10;
                player.vx *= -0.5;
            }
            if (player.x > width - 10) {
                player.x = width - 10;
                player.vx *= -0.5;
            }

            if (player.y > GROUND_Y()) {
                player.y = GROUND_Y();
                player.vy = 0;
                player.grounded = true;
            }

            // ãƒ’ãƒ¨ã‚³å‡¦ç†
            chicks.forEach((c) => {
                if (c.state === "flying") {
                    c.y -= 2; // é€Ÿåº¦èª¿æ•´
                    c.x += Math.sin(frameCount * 0.05) * 1.5;
                    if (c.y < -50) {
                        score += 500;
                        chickensGrown++;
                        showFloatText(width / 2, height / 2, "ã™ãã™ããƒœãƒ¼ãƒŠã‚¹ 500PT", "#FFD700");
                        playSound("feed");
                        c.state = "waiting";
                        c.waitTimer = 180;
                    }
                    return;
                }
                if (c.state === "waiting") {
                    c.waitTimer--;
                    if (c.waitTimer <= 0) {
                        c.state = "entering";
                        c.stage = 0;
                        c.emoji = "ğŸ£";
                        c.scale = 1.0;
                        c.x = Math.random() > 0.5 ? -50 : width + 50;
                        c.targetX = Math.random() * (width - 60) + 30;
                        c.baseY = GROUND_Y() - (c.row === "high" ? CHICK_ZONE_HIGH_OFFSET : CHICK_ZONE_HIGHEST_OFFSET) - Math.random() * 20;
                        c.y = c.baseY;
                    }
                    return;
                }
                if (c.state === "entering") {
                    const dx = c.targetX - c.x;
                    c.x += dx * 0.02; // ä¿‚æ•°èª¿æ•´
                    c.y = c.baseY + Math.sin(frameCount * 0.08) * 15;
                    if (Math.abs(dx) < 10) c.state = "idle";
                    return;
                }
                if (c.stage >= 3) {
                    c.state = "flying";
                    return;
                }
                if (c.stage === 0) c.emoji = "ğŸ£";
                else if (c.stage === 1) c.emoji = "ğŸ¥";
                else if (c.stage === 2) c.emoji = "ğŸ“";

                const dx = c.targetX - c.x;
                c.x += dx * 0.01; // ä¿‚æ•°èª¿æ•´
                if (Math.abs(dx) < 10 && Math.random() < 0.01) {
                    c.targetX = Math.random() * (width - 60) + 30;
                }
            });

            // ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾é »åº¦èª¿æ•´ (60fpsãªã®ã§å€ã®é–“éš”ã«)
            let spawnRate = feverTimer > 0 ? 60 : 180;
            if (frameCount % spawnRate === 0) spawnItem();

            if (frameCount % 400 === 0 && Math.random() < 0.7) spawnEnemy();
            if (frameCount % 600 === 0 && Math.random() < 0.4) spawnCactus();

            // ã‚¢ã‚¤ãƒ†ãƒ æ›´æ–°
            for (let i = items.length - 1; i >= 0; i--) {
                let it = items[i];
                it.vy += GRAVITY * 0.2; // èª¿æ•´
                if (it.vy > 3) it.vy = 3;
                it.x += it.vx;
                it.y += it.vy;
                it.rot += it.rotSpeed;
                it.vx *= 0.99;

                if (it.x < 15) { it.x = 15; it.vx *= -0.8; }
                if (it.x > width - 15) { it.x = width - 15; it.vx *= -0.8; }
                if (it.y > height + 50) { items.splice(i, 1); continue; }

                if (!player.grounded && !player.stunned) {
                    const distX = Math.abs(player.x - it.x);
                    const distY = Math.abs(player.y - player.height / 2 - it.y);

                    if (distX < 40 && distY < 45) {
                        if (it.type === "pepper") {
                            player.stunned = true;
                            player.stunTimer = 90;
                            health -= 15;
                            playSound("damage");
                            createParticles(player.x, player.y, 8, "#FF0000");
                            showFloatText(player.x, player.y - 30, "ã—ã³ã‚ŒãŸ!!", "red");
                            items.splice(i, 1);
                            if (health <= 0) gameOver();
                            continue;
                        }
                        if (it.type === "onigiri") {
                            health = Math.min(health + 20, maxHealth);
                            playSound("heal");
                            createParticles(it.x, it.y, 15, "#fff");
                            showFloatText(it.x, it.y, "å›å¾©!", "#00AA00");
                            if (Math.random() < 0.2) {
                                feverTimer = FEVER_DURATION;
                                showFloatText(width / 2, height / 2, "FEVER START!", "#FF0055");
                            }
                            items.splice(i, 1);
                            continue;
                        }
                        if (NORMAL_FOODS.includes(it.type)) {
                            if (it.vy > 0) {
                                playSound("hit");
                                it.vy = -7 - Math.random() * 3; // è·³ã­è¿”ã‚Šèª¿æ•´
                                it.vx = (Math.random() - 0.5) * 6 + player.vx * 0.6;
                                health -= 2;
                                createParticles(it.x, it.y, 4, "orange");
                                if (health <= 0) { health = 0; gameOver(); }
                            }
                        }
                    }
                }
                // ãƒ’ãƒ¨ã‚³åˆ¤å®š
                if (it.vy < 0 && NORMAL_FOODS.includes(it.type)) {
                    for (let c of chicks) {
                        if (c.stage >= 3 || c.state !== "idle") continue;
                        const cDist = Math.hypot(c.x - it.x, c.y - it.y);
                        if (cDist < 45) {
                            score += 100;
                            items.splice(i, 1);
                            playSound("feed");
                            createParticles(c.x, c.y, 8, "#FFFF00");
                            showFloatText(c.x, c.y - 20, "ã†ã¾ãƒ¼ã„", "#333");
                            c.stage++;
                            c.scale = 1.5;
                            setTimeout(() => (c.scale = 1.0), 200);
                            break;
                        }
                    }
                }
            }

            // æ•µæ›´æ–°
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                e.life--;
                if (e.type === "bee") {
                    e.x += e.vx * 0.5; // é€Ÿåº¦èª¿æ•´
                    e.y = e.baseY + Math.sin(frameCount * 0.05) * 30;
                } else if (e.type === "dog") {
                    e.x += e.vx * 0.5;
                    if (e.y >= GROUND_Y()) e.vy = -6;
                    e.vy += GRAVITY;
                    e.y += e.vy;
                    if (e.y > GROUND_Y()) e.y = GROUND_Y();
                }
                if (e.x < -100 || e.x > width + 100 || e.life <= 0) {
                    enemies.splice(i, 1);
                    continue;
                }
                if (!player.stunned) {
                    const ex = e.x;
                    const ey = e.type === "dog" ? e.y - 10 : e.y;
                    const dist = Math.hypot(player.x - ex, player.y - 20 - ey);
                    if (dist < 25) {
                        health -= (e.type === "bee" ? 15 : 10);
                        player.stunned = true;
                        player.stunTimer = 45;
                        playSound("damage");
                        player.vx = e.vx > 0 ? 5 : -5;
                        createParticles(player.x, player.y, 8, "#880000");
                        showFloatText(player.x, player.y - 30, "ç—›ãƒƒ!!", "red");
                        enemies.splice(i, 1);
                        if (health <= 0) { health = 0; gameOver(); }
                    }
                }
            }

            // ã‚µãƒœãƒ†ãƒ³
            for (let i = cactusList.length - 1; i >= 0; i--) {
                let c = cactusList[i];
                c.life--;
                if (c.state === "growing") {
                    c.scale += 0.03; // æˆé•·é€Ÿåº¦èª¿æ•´
                    if (c.scale >= 1.0) { c.scale = 1.0; c.state = "active"; }
                } else if (c.life < 20) c.scale -= 0.05;

                if (c.life <= 0) { cactusList.splice(i, 1); continue; }

                if (c.state === "active" && !player.stunned) {
                    const dist = Math.hypot(player.x - c.x, player.y - 10 - c.y);
                    if (dist < 25) {
                        health -= 10;
                        player.stunned = true;
                        player.stunTimer = 60;
                        playSound("bounce");
                        createParticles(player.x, player.y, 8, "#2E7D32");
                        showFloatText(player.x, player.y - 30, "ç—›ãƒƒ!!", "red");
                        const bounceDir = player.x < c.x ? -1 : 1;
                        player.vx = bounceDir * 8;
                        player.vy = -6;
                        if (health <= 0) { health = 0; gameOver(); }
                    }
                }
            }

            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                if (p.life <= 0) particles.splice(i, 1);
            }

            // é›²
            CLOUDS.forEach((c) => {
                c.x += c.speed;
                if (c.x > width + 150) c.x = -200;
            });

            // æµ®éŠãƒ†ã‚­ã‚¹ãƒˆ
            for (let i = floatingTexts.length - 1; i >= 0; i--) {
                let t = floatingTexts[i];
                t.y -= 0.5;
                t.life--;
                if (t.life <= 0) floatingTexts.splice(i, 1);
            }
        }

        function draw() {
            drawClouds();

            // åœ°é¢
            ctx.fillStyle = "#8BC34A";
            ctx.fillRect(0, GROUND_Y(), width, height - GROUND_Y());
            ctx.strokeStyle = "#558B2F";
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(0, GROUND_Y());
            ctx.lineTo(width, GROUND_Y());
            ctx.stroke();

            // ãƒ’ãƒ¨ã‚³
            chicks.forEach((c) => {
                if (c.state === "waiting") return;
                ctx.save();
                ctx.translate(c.x, c.y);
                if (c.scale !== 1.0) ctx.scale(c.scale, c.scale);
                let size = 30;
                if (c.stage === 0) size = 24;
                else if (c.stage === 1) size = 36;
                else if (c.stage === 2) size = 42;
                else if (c.stage >= 3) size = 48;
                const img = getEmojiImage(c.emoji, size);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            });

            // ã‚µãƒœãƒ†ãƒ³
            cactusList.forEach((c) => {
                ctx.save();
                ctx.translate(c.x, c.y);
                ctx.scale(1, c.scale);
                const img = getEmojiImage(c.emoji, 35);
                ctx.drawImage(img, -img.width / 2, -img.height + 5);
                ctx.restore();
            });

            // æ•µ
            enemies.forEach((e) => {
                ctx.save();
                ctx.translate(e.x, e.y);
                if (e.vx > 0) ctx.scale(-1, 1);
                const img = getEmojiImage(e.emoji, 30);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            });

            drawPlayer();

            // ã‚¢ã‚¤ãƒ†ãƒ 
            items.forEach((it) => {
                ctx.save();
                ctx.translate(it.x, it.y);
                ctx.rotate(it.rot);
                let size = it.type === "onigiri" ? 36 : FOOD_SIZE_BASE;
                if (player.grounded && it.y > player.y - 50 && Math.abs(player.x - it.x) < 40) {
                    ctx.globalAlpha = 0.6;
                }
                const img = getEmojiImage(it.emoji, size);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.globalAlpha = 1.0;
                ctx.restore();
            });

            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
            particles.forEach((p) => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
            });

            // æµ®éŠãƒ†ã‚­ã‚¹ãƒˆ (è»½é‡åŒ–: strokeTextå‰Šé™¤)
            floatingTexts.forEach((t) => {
                ctx.font = "bold 15px sans-serif";
                // å½±ã‚’ã¤ã‘ã¦è¦–èªæ€§ã‚’ç¢ºä¿ï¼ˆstrokeTextã‚ˆã‚Šè»½ã„ï¼‰
                ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.fillText(t.text, t.x + 1, t.y + 1);
                ctx.fillStyle = t.color;
                ctx.fillText(t.text, t.x, t.y);
            });

            drawUI();
        }

        function spawnItem() {
            if (items.length >= MAX_ITEMS) return;
            const rand = Math.random();
            let type, emoji;
            let pepperRate = 0.2;
            let onigiriRate = 0.1;
            if (health <= 30) onigiriRate = 0.2;

            if (rand < pepperRate) { type = "pepper"; emoji = "ğŸŒ¶ï¸"; }
            else if (rand < pepperRate + onigiriRate) { type = "onigiri"; emoji = "ğŸ™"; }
            else {
                type = NORMAL_FOODS[Math.floor(Math.random() * NORMAL_FOODS.length)];
                emoji = type;
            }
            items.push({
                x: Math.random() * (width - 40) + 20,
                y: -30,
                vx: 0, vy: 0, rot: 0,
                rotSpeed: (Math.random() - 0.5) * 0.1,
                type: type, emoji: emoji
            });
        }

        function spawnEnemy() {
            if (enemies.length >= MAX_ENEMIES) return;
            const isLeft = Math.random() > 0.5;
            const startX = isLeft ? -50 : width + 50;
            const speed = isLeft ? Math.random() * 2 + 2 : -(Math.random() * 2 + 2);

            if (Math.random() > 0.5) {
                enemies.push({
                    type: "dog", emoji: "ğŸ•",
                    x: startX, y: GROUND_Y(), baseY: GROUND_Y(),
                    vx: speed * 1.2, vy: 0, life: 1200
                });
            } else {
                const beeY = GROUND_Y() - 70;
                enemies.push({
                    type: "bee", emoji: "ğŸ",
                    x: startX, y: beeY, baseY: beeY + Math.random() * 20,
                    vx: speed, vy: 0, life: 1200
                });
            }
        }

        function spawnCactus() {
            if (cactusList.length >= MAX_CACTUS) return;
            cactusList.push({
                x: Math.random() * (width - 100) + 50,
                y: GROUND_Y(), emoji: "ğŸŒµ",
                life: 600, scale: 0, state: "growing"
            });
        }

        function drawPlayer() {
            const x = player.x;
            const y = player.y;
            ctx.save();
            ctx.strokeStyle = player.color;
            ctx.lineWidth = 2.5;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            if (player.stunned) {
                ctx.strokeStyle = Math.floor(frameCount / 8) % 2 === 0 ? "#FFFF00" : "#333";
                if (Math.random() < 0.3) ctx.translate((Math.random() - 0.5) * 2, 0);
            }
            // ä½“
            ctx.beginPath();
            ctx.moveTo(x, y); ctx.lineTo(x, y - 25); ctx.stroke();
            // è¶³
            ctx.beginPath();
            if (player.grounded) {
                ctx.moveTo(x, y); ctx.lineTo(x - 5, y + 10);
                ctx.moveTo(x, y); ctx.lineTo(x + 5, y + 10);
            } else {
                ctx.moveTo(x, y); ctx.lineTo(x - 7, y + 5);
                ctx.moveTo(x, y); ctx.lineTo(x + 7, y + 10);
            }
            ctx.stroke();
            // æ‰‹
            ctx.beginPath();
            if (player.stunned) {
                ctx.moveTo(x, y - 18); ctx.lineTo(x - 7, y - 5);
                ctx.moveTo(x, y - 18); ctx.lineTo(x + 7, y - 5);
            } else {
                ctx.moveTo(x, y - 18); ctx.lineTo(x - 10, y - 10);
                ctx.moveTo(x, y - 18); ctx.lineTo(x + 10, y - 25);
            }
            ctx.stroke();
            // é ­
            ctx.beginPath();
            ctx.arc(x, y - 30, 7, 0, Math.PI * 2);
            ctx.fillStyle = player.stunned ? "#E0E0E0" : "#FFF";
            ctx.fill();
            ctx.stroke();
            ctx.restore();
        }

        function drawClouds() {
            ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
            CLOUDS.forEach((c) => {
                ctx.beginPath();
                ctx.ellipse(c.x, c.y, c.w, c.h, 0, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawUI() {
            const topMargin = 50;
            const rightMargin = 20;
            ctx.fillStyle = "#333";
            ctx.font = "bold 18px sans-serif";
            ctx.textAlign = "right";
            ctx.fillText("Score: " + score, width - rightMargin, topMargin);

            const barX = 30;
            const barY = topMargin - 12;
            const barW = 100;
            const barH = 10;

            const img = getEmojiImage("ğŸ’ª", 18);
            ctx.drawImage(img, 5, topMargin - 18 / 2 - 5);

            ctx.fillStyle = "#fff";
            ctx.fillRect(barX, barY, barW, barH);
            const currentBarW = (health / maxHealth) * barW;
            if (health > 50) ctx.fillStyle = "#4CAF50";
            else if (health > 20) ctx.fillStyle = "#FFC107";
            else ctx.fillStyle = "#F44336";
            ctx.fillRect(barX, barY, currentBarW, barH);
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 1;
            ctx.strokeRect(barX, barY, barW, barH);
        }
    </script>
</body>
</html>
